## Codebase Patterns
- Use uv to manage deps and venv; activate before any execution
- config.yaml sections: proxy, captcha, scraping, retry, database, logging, input_csv
- Typecheck with `uv run pyright scraper/` (only .py files)
- Wrap config.get() returns with str() to satisfy pyright type narrowing
- Use `datetime.now(timezone.utc)` not deprecated `datetime.utcnow()`
- stem library has no type stubs; use `# pyright: ignore[reportAttributeAccessIssue]` for Signal.NEWNYM
- Controller.from_port() `port` param typed as str in stubs; pass str not int
- 2captcha-python: `solver.recaptcha()` can return None; guard before subscripting result
- Import exceptions from twocaptcha: ApiException, NetworkException, TimeoutException, ValidationException

---

## 2026-02-04 - US-001
- Replaced Michelin config.yaml with CNMC sections (proxy/tor, captcha/2captcha, scraping, database, logging)
- Updated requirements.txt to include 2captcha-python>=1.0
- Set up uv project with pyproject.toml
- Files changed: config.yaml, requirements.txt, pyproject.toml, uv.lock, .python-version
- **Learnings for future iterations:**
  - Existing codebase is a Michelin restaurant scraper; each story will replace modules
  - pyright errors on existing Michelin Python code are pre-existing, will be fixed as modules are rewritten
  - Run typecheck with `uv run pyright scraper/` not on yaml/txt files
---

## 2026-02-04 - US-002
- Replaced Michelin restaurant schema with CNMC portability + progress tables
- upsert_result uses ON CONFLICT ... DO UPDATE for clean upserts
- get_progress returns 0 when no row found, update_progress upserts via ON CONFLICT
- Used str() cast on config.get() return to satisfy pyright type narrowing
- Files changed: scraper/database.py
- **Learnings for future iterations:**
  - config.get() returns Unknown type to pyright; wrap with str() for path params
  - Use `datetime.now(timezone.utc)` instead of deprecated `datetime.utcnow()`
---

## 2026-02-04 - US-003
- Created scraper/csv_reader.py: read_phones() reads single-column CSV, validates 9-digit Spanish mobile (starts 6/7), deduplicates, logs count
- Falls back to config.yaml input_csv when no path arg provided
- Files changed: scraper/csv_reader.py
- **Learnings for future iterations:**
  - Python 3.10+ `str | None` union syntax works fine with pyright, no need for Optional
  - Use re.compile for regex patterns used in loops
---

## 2026-02-04 - US-004
- Rewrote scraper/proxy_pool.py: config-driven ProxyPool class using stem
- rotate_if_needed(query_count) rotates every N (default 9) queries via NEWNYM
- 10s minimum wait between rotations enforced in _rotate()
- Config read from proxy + scraping sections; connect() verifies control port
- Added force_rotate() for immediate rotation on blocks, reset_counter() available
- Files changed: scraper/proxy_pool.py
- **Learnings for future iterations:**
  - stem has no pyright-compatible type stubs; Signal.NEWNYM needs pyright ignore comment
  - Controller.from_port() port param is typed as str in stubs, not int
---

## 2026-02-04 - US-005
- Created scraper/captcha.py: CaptchaSolver class wrapping 2captcha-python SDK
- detect_sitekey(page) extracts reCAPTCHA sitekey via data-sitekey attr or grecaptcha.render regex
- solve(sitekey, page_url) sends to 2Captcha, returns token or None on error
- inject_token(page, token) sets g-recaptcha-response element + triggers reCAPTCHA callbacks
- Handles all 2Captcha exceptions: ApiException, NetworkException, TimeoutException, ValidationException
- Files changed: scraper/captcha.py, prd.json, progress.txt
- **Learnings for future iterations:**
  - solver.recaptcha() return type is Optional; must guard None before subscript
  - twocaptcha package exports exceptions at top level
---
